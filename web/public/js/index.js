var DEFAULT_MSG;function load(){processHash();getGeo()}function processHash(){var a=document.getElementById("searchBox"),b=decodeURI(window.location.hash.substr(1));if(a.value!==b)a.value=b,search()}function getGeo(){(!myLat||!myLong)&&navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(a){if(!(a.coords.accuracy>250))myLat=a.coords.latitude,myLong=a.coords.longitude},function(a){a.code!=a.PERMISSION_DENIED&&alert("Error getting geolocation")})}window.onhashchange=load;
window.onload=load;String.prototype.trim=function(){return this.replace(/^\s\s*/,"").replace(/\s\s*$/,"")};String.prototype.toCapitalize=function(){return this.toLowerCase().replace(/^.|\s\S/g,function(a){return a.toUpperCase()})};function validateInt(a){return""+parseInt(a)==a}
function prettyPlaceName(a,b,c){var a=a.replace(/-/g," ").toCapitalize(),a=a.split(" "),b=b.split(","),b=b[b.length-2].trim(),d=a.pop();b.indexOf(" ")>-1&&a.pop();validateInt(d)&&(b+=" "+d,a.pop());return a.join(" ")+(c?"</h1><h2>"+b+"</h2>":", "+b)}function makeClickable(a){return a?'<a href="#" onclick="return exampleClicked(this);">'+a.join('</a><br><a href="#" onclick="return exampleClicked(this); ">').replace(/-/g," ")+"</a>":""}
function polarityAvg(a){if(!a)return 3.757;for(var b=0,c=0,d=0;d<a.length;d++)b+=a[d]*(d+1),c+=a[d];return c<10?3.757:b/c}function polarityToColor(a,b){return b?a>4.2?"00cc00":a>3.7?"006600":a>3?"222222":a>2.3?"880000":"ee0000":a>4.2?"00ff00":a>3.7?"008800":a>3?"4c4c4c":a>2.3?"880000":"ff0000"}
var socket=io.connect(),reviews,placeData,categorizedData,meta,similar,backStack=[],myLat,myLong,sortOrder=[false,false,false,false],SIDEBAR_ELEMS="Overview,Food,Service,Decor,Overall,Other,Similar".split(","),MAX_ATTRIBUTES_SHOWN=15,MAX_VALUES_SHOWN=6;
socket.on("match",function(a){categorizedData={};placeData={};meta=a.meta;similar=a.similar;reviews=a.reviews;for(var b=a.attributeCategories,c={},d={},f=0,g=a.data.length;f<g;f++){var h=a.data[f][0],j=a.data[f][1],k=b[h];k in categorizedData||(categorizedData[k]={},d[k]=[],c[k]=0);if(!(c[k]++>=MAX_ATTRIBUTES_SHOWN)){categorizedData[k][h]={};placeData[h]={};valueCount=0;for(var m in j){if(valueCount++>=MAX_VALUES_SHOWN)break;count=j[m][0].length;polarity=polarityAvg(j[m][1]);for(l=0;l<count;l++)j[m][0][l][0]=
j[m][0][l][0].trim();placeData[h][m.slice(2)]=j[m][0];categorizedData[k][h][m.slice(2)]={count:count,polarity:polarity};if(!(m in a.filteredValues))for(l=0;l<Math.sqrt(count)+1;l++)d[k].push(polarity)}}}b='<div id="header" style="height:60px"><div style="float:left; margin-right:25px"><h1>'+prettyPlaceName(a.place,a.meta.Address,true)+'</div><div id="opendistance" style="float:right"><span'+getOpen(a.meta,false)+"</span>";myLat&&myLong&&(b+="<br>"+getLocation(a.meta));b+="</div></div>";for(var a=
'<div><div id="sidebar" style="clear:both"><table>',l=0;l<SIDEBAR_ELEMS.length;l++)c=SIDEBAR_ELEMS[l],a+='<tr><td class="sb_elem" id="'+c+'" style="color:#ff6600"',a+="onclick=\"sidebarClicked('"+c+"');\">"+c+"</td>",c in categorizedData&&(a+='<td><canvas id="'+c+'Bar" width="100" height="14"></canvas></td>'),a+="</tr>";a+="</table></div>";outputHtml(b+a+'<div id="content" style="clear:right">bla</div></div>');sidebarClicked(SIDEBAR_ELEMS[0]);for(l=0;l<SIDEBAR_ELEMS.length;l++)c=SIDEBAR_ELEMS[l],
c in categorizedData&&setTiles(100,14,7,c,d[c])});var fadeOut;function submitFeedback(){var a=document.getElementById("feedbackBox");a.value&&socket.emit("giveFeedback",a.value);document.getElementById("feedbackBox").value="Thanks!";fadeOut||(fadeOut=setTimeout("toggleFeedback()",2E3))}
function toggleFeedback(){var a=document.getElementById("feedbackForm");a.style.display=a.style.display=="inline-block"?"none":"inline-block";clearTimeout(fadeOut);fadeOut=null;document.getElementById("feedbackBox").value=""}
var tooltip=function(){var a=0,b,c,d,f,g,h=document.all?true:false;return{show:function(a,h){if(b==null)b=document.createElement("div"),b.setAttribute("id","tt"),c=document.createElement("div"),c.setAttribute("id","tttop"),d=document.createElement("div"),d.setAttribute("id","ttcont"),f=document.createElement("div"),f.setAttribute("id","ttbot"),b.appendChild(c),b.appendChild(d),b.appendChild(f),document.body.appendChild(b),b.style.opacity=0,b.style.filter="alpha(opacity=0)",document.onmousemove=this.pos;
d.innerHTML=a;b.style.width=h+"px";if(b.offsetWidth>300)b.style.width="300px";b.style.display="block";g=parseInt(b.offsetHeight)+3;b.style.display="none";b.timer2=setTimeout("tooltip.display()",500)},pos:function(a){var c=h?event.clientX+document.documentElement.scrollLeft:a.pageX;b.style.top=(h?event.clientY+document.documentElement.scrollTop:a.pageY)-g+"px";b.style.left=c+3+"px"},display:function(){b.style.display="block";g=parseInt(b.offsetHeight)+3;clearInterval(b.timer);b.timer=setInterval(function(){tooltip.fade(1)},
10)},fade:function(c){var d=a;if(d!=92&&c==1||d!=0&&c==-1){var f=15;92-d<15&&c==1?f=92-d:a<15&&c==-1&&(f=d);a=d+f*c;b.style.opacity=a*0.01;b.style.filter="alpha(opacity="+a+")"}else if(clearInterval(b.timer),c==-1)b.style.display="none"},hide:function(){clearTimeout(b.timer2);clearInterval(b.timer);b.timer=setInterval(function(){tooltip.fade(-1)},10)}}}();function showTooltip(a,b){tooltip.show('"'+String(placeData[a][b][0][0]).replace(/^\s*/,"").replace(/\s*$/,"")+'"',300)}
function sidebarClicked(a){for(var b=0;b<SIDEBAR_ELEMS.length;b++)e=SIDEBAR_ELEMS[b],text=document.getElementById(e),text.style.color=e==a?"#000000":"#ff6600";var c="<h4>"+a+"</h4>";if(a in categorizedData){backStack.push([sidebarClicked,a]);attributeData=categorizedData[a];c+="<table>";for(attribute in attributeData){c+='<tr><td class="attribute"><a style="color:#ff6600" href="#"onclick="return attributeClicked(\''+attribute+"');\">"+attribute+"</a></td><td>";var a=[],d=[];for(value in attributeData[attribute])d.push([value,
attributeData[attribute][value].polarity]);d.sort(function(a,b){return b[1]-a[1]});for(b=0;b<d.length;b++){value=d[b][0];polarity=d[b][1];count=attributeData[attribute][value].count;var f='<a href="#" style="color:#'+polarityToColor(polarity,true)+'" onclick="return valueClicked(\''+attribute+"','"+value+"');\"onmouseover=\"showTooltip('"+attribute+"','"+value+'\');"onmouseout="tooltip.hide();">'+value.replace("!","not ")+"</a>";count>1&&(f+=" ("+count+")");a.push(f)}c+=a.join(", ")+"</td></tr>"}c+=
"</table></div>"}else if(a=="Similar")c+="People had similar opinions about<br><br>",c+=makeClickable(similar)+"</div>";else if(a=="Overview"){a={Latitude:0,Longitude:0,"Business Name":0,"Business type":0,Category:0,Categories:0,Hours:0};d={Address:0,"Phone number":0};c+="<table>";var f=function(a,b){return'<c style="color:#ff6600">'+a+':</c>  <c style="color:#007700">'+b+"<c>"},g;meta.Categories?g="Categories":meta.Category&&(g="Category");if(g){categoryStrings=meta[g].split(", ");categories=[];
for(b=0;b<categoryStrings.length;b++)categories.indexOf(categoryStrings[b])==-1&&categories.push(categoryStrings[b]);c+="<tr><td>"+f("Categories",categories.join(", "))+"</td></tr>";c+="<tr><td></td></tr>"}for(attribute in d)c+='<tr><td><c style="color:#007700">'+meta[attribute]+"</c></td></tr>";c+="</table><br>";"Hours"in meta&&(c+="<table><tr>",c+='<td style="padding-right:5px;"><c style="color:#ff6600">Hours:</c></td>',c+='<td><c style="color:#007700">'+meta.Hours+"<c></td>",c+="</td></table>");
c+="<table><tr>";b=0;for(attribute in meta)attribute in a||attribute in d||(b+=1,b%2==0?(c+="<td>"+f(attribute,meta[attribute])+"</td>",c+="</tr><tr>"):c+='<td style="padding-right:40px">'+f(attribute,meta[attribute])+"</td>");c+="</tr>"}document.getElementById("content").innerHTML=c}
function setTiles(a,b,c,d,f){for(var f=f.sort().reverse(),c=document.getElementById(d+"Bar").getContext("2d"),g=0,h=d=0;h<f.length;h++){var j=polarityToColor(f[h],false);j!=d&&h!=0&&(g+=2);d=j}a=(a-g)/f.length;for(h=d=g=0;h<f.length;h++){j=polarityToColor(f[h],false);if(j!=d&&h!=0)c.fillStyle="#ffffff",c.fillRect(g,0,g+2,b),g+=2;c.fillStyle="#"+j;c.fillRect(g,0,g+a+1,b);g+=a;d=j}}socket.on("suggestions",function(a){a.length>1?outputHtml(makeClickable(a)):outputHtml(a[0])});
socket.on("results",function(a){var b="<h3>Processed Query: "+a.query+" in "+a.time+"ms ("+a.num+" results)</h3>";b+='<table id="results"><tr>';b+='<td id="sort-name" style="color:#0000AA" onmouseover="this.style.cursor=\'pointer\'" onclick="sortBy(\'placeName\', 0, this);">Restaurant Name</td>';b+='<td id="sort-open" style="color:#0000AA" onmouseover="this.style.cursor=\'pointer\'" onclick="sortBy(\'isOpen\', 2, this);">Open</td>';myLat&&myLong&&(b+='<td id="sort-distance" style="color:#0000AA; cursor: pointer"  onclick="sortBy(\'distance\', 3, this);">Distance</td> &nbsp;');
b+='<td id="sort-price" style="color:#0000AA" onmouseover="this.style.cursor=\'pointer\'" onclick="sortBy(\'price\', 4, this);">Price</td> &nbsp;';var c=1,d;for(d in a.data)b+="<tr id=result_"+c+'><td class="placeName"><a href="#" onclick="return exampleClicked(this);">'+prettyPlaceName(d,a.meta[d].Address)+"</a></td>",b+='<td class="isOpen">'+getOpen(a.meta[d],true)+"</td>",myLat&&myLong&&(b+='<td class="distance">'+getLocation(a.meta[d])+"</td>&nbsp;&nbsp;"),a.meta[d]["Price Range"]&&(b+='<td class="price">'+
a.meta[d]["Price Range"]+"</td>"),b+="</tr>",c++;b+="</table>";a.suggestions.length>0&&(b='<div id="similar"><h3>Name Matches</h3>'+makeClickable(a.suggestions)+'</div><div id="extractions">'+b+"</div>");outputHtml(b)});socket.on("connect",function(){var a=document.getElementById("searchBox");a.value.length>0&&socket.emit("search",a.value.replace("not ","!"))});
function sortBy(a,b,c){var d;c.className?(sortOrder[b]=!sortOrder[b],d=sortOrder[b]):(d=false,sortOrder=[false,false,false,false]);for(var f=document.getElementById("results").rows[0].getElementsByTagName("td"),b=0;b<f.length;b++)f[b].style.color="#0000AA",f[b].style.textDecoration="none",f[b].removeAttribute("class");c.style.color="#000000";c.style.textDecoration="underline";c.className="sortable-selected";c=[];f=document.getElementById("results");for(b=1;b<f.rows.length;b++)for(var g="result_"+
b,h=document.getElementById(g).childNodes,j=0;j<h.length;j++)if(h[j].className==a){var k=h[j].innerHTML.trim();k.indexOf("<")==0&&(k=k.substring(k.indexOf(">")+1,k.indexOf("<",1)));c.push(k+"_"+g)}c.sort(function(a,b){if(!a&&!b)return-1;if(!a)return 1;if(!b)return-1;var c=parseFloat(b)-parseFloat(a);if(!c&&c!=0){var c=a.substring(0,a.indexOf("_")),f=b.substring(0,b.indexOf("_"));if(c<f)c=1;else if(c>f)c=-1;else return parseInt(a.substr(a.lastIndexOf("_")+1))-parseInt(b.substr(b.lastIndexOf("_")+1))}return d?
c:-c});for(b=c.length-1;b>=0;b--)g=c[b].substr(c[b].indexOf("_")+1),a=document.getElementById(g),a.parentNode.insertBefore(a,f.rows[1])}function outputHtml(a){if(!DEFAULT_MSG)DEFAULT_MSG=document.getElementById("serverMsg").innerHTML;a||(a=DEFAULT_MSG);document.getElementById("serverMsg").innerHTML=a}function backClicked(){backStack.pop();var a=backStack.pop();a[0](a[1])}
function valueClicked(a,b){backStack.push([valueClicked,[a,b]]);tooltip.hide();var c='<table width="100%"><tr><td><h4>Reviews mentioning "'+b+" "+a+'"</h4></td>';c+='<td><div class="sb_elem" style="color:#ff6600"';c+='onclick="backClicked();">Back</div></td></tr></table>';data=placeData[a][b];for(i=0;i<data.length;i++){sentence=data[i][0];review=reviews[data[i][1]];var d=review.indexOf(sentence);d!=-1?(c+=review.slice(0,d),c+='<font color="#ff6600">'+sentence+"</font>",c+=review.slice(d+sentence.length,
review.length)):c+=review;c+="<br><br>"}document.getElementById("content").innerHTML=c;return false}
function displayReview(a,b,c){backStack.push([displayReview,[a,b,c]]);var d='<table width="100%"><tr><td><h4>Source of the sentence </h4></td>';d+='<td style="padding-right:0"><div class="sb_elem" style="color:#ff6600"';d+='onclick="backClicked();">Back</div></td></tr></table>';review=reviews[placeData[a][b][c][1]];sentence=placeData[a][b][c][0];a=review.indexOf(sentence);a!=-1?(d+=review.slice(0,a),d+='<font color="#ff6600">'+sentence+"</font>",d+=review.slice(a+sentence.length,review.length)):d+=
review;document.getElementById("content").innerHTML=d;return false}
function attributeClicked(a){backStack.push([attributeClicked,a]);var b='<table width="100%"><tr><td><h4>Review sentences about "'+a+'"</h4></td>';b+='<td><div class="sb_elem" style="color:#ff6600"';b+='onclick="backClicked();">Back</div></td></tr></table>';for(value in placeData[a])for(i=0;i<placeData[a][value].length;i++)review=placeData[a][value][i][1],sentence=placeData[a][value][i][0],b+='<a style="cursor:pointer" onclick="return displayReview(\''+a+"','"+value+"',"+i+');">"'+sentence+'"</a>',
b+="<br><br>";document.getElementById("content").innerHTML=b;return false}function exampleClicked(a){document.getElementById("searchBox").value=a.innerHTML;search();return false}function search(a){var b=document.getElementById("searchBox").value.toLowerCase();if(search.lastMsg!==b||!a){search.lastMsg=b;var c="search";a&&(c="change");b.length===0&&outputHtml(DEFAULT_MSG);socket.emit(c,b.replace("not ","!"))}if(!a)location.href="http://"+location.hostname+"/#"+encodeURI(b)}
function getLocation(a){if(!a||!a.Latitude||!a.Longitude)return"";var b=a.Latitude,c=a.Longitude;lat2=myLat;lon2=myLong;a=(lat2-b)*Math.PI/180;c=(lon2-c)*Math.PI/180;b=b*Math.PI/180;lat2=lat2*Math.PI/180;b=Math.sin(a/2)*Math.sin(a/2)+Math.sin(c/2)*Math.sin(c/2)*Math.cos(b)*Math.cos(lat2);b=3963*2*Math.atan2(Math.sqrt(b),Math.sqrt(1-b));b=Math.round(b*10)/10;a=Math.atan(a/c);return a<=-3*Math.PI/8?c<0?b+" mi. S":b+" mi. N":a<=-Math.PI/8?c<0?b+" mi. SE":b+" mi. NW":a<=Math.PI/8?c<0?b+" mi. E":b+" mi. W":
a<=3*Math.PI/8?c<0?b+" mi. NE":b+" mi. SW":c<0?b+" mi. N":b+" mi. S"}
function getOpen(a,b){if(a.Hours){for(var c=a.Hours.split(" & "),d=Array(7),f=0;f<d.length;f++)d[f]=[];for(f=0;f<c.length;f++)var g=c[f].search(/[0-9]/),h=c[f].substring(0,g),g=c[f].substring(g,c[f].length),d=getOpenTimes(h,g,d);c=new Date;if(d[c.getDay()])for(var h=c.getHours()*60+c.getMinutes(),j=0,f=0;f<d[c.getDay()].length;f++){var g=d[c.getDay()][f].start,k=d[c.getDay()][f].end;if(k==g||k<g&&(h<=k||h>=g)||h>=g&&h<=k)return b?'<img height="25" width="25" src="green-check.png" alt="Now Open" onmouseover="tooltip.show(\'Closes at: '+
getTimeFromMinutes(k)+'\', 100)" onmouseout="tooltip.hide()">':' class="isOpen" style="color:#007700">Currently Open';else if(k<g&&h>g||h<g)j=g}return b?'<img height="25" width="25" src="red-x.png" alt="Now Closed" onmouseover="tooltip.show(\'Next Open at: '+getTimeFromMinutes(j)+'\', 100)" onmouseout="tooltip.hide()">':' class="isOpen" style="color:#AA0000">Currently Closed'}return b?'<img height="25" width="25" src="question-mark.png" alt="Unknown hours">':">"}
function getOpenTimes(a,b,c){var d=[];d.sun=0;d.mon=1;d.tue=2;d.wed=3;d.thu=4;d.fri=5;d.sat=6;for(var b=b.split(" "),a=a.split(","),f=0;f<a.length;f++){var g=a[f],h=g.indexOf("-");if(h==-1)c[d[g.trim().toLowerCase()]].push({start:getMinutes(b[0],b[1]),end:getMinutes(b[3],b[4])});else{var j=d[g.substring(0,h).trim().toLowerCase()],g=d[g.substring(h+1,g.length).trim().toLowerCase()];if(g<j){for(h=0;h<=g;h++)c[h].push({start:getMinutes(b[0],b[1]),end:getMinutes(b[3],b[4])});g=6}for(h=j;h<=g;h++)c[h].push({start:getMinutes(b[0],
b[1]),end:getMinutes(b[3],b[4])})}}return c}function getTimeFromMinutes(a){var b,c;b=a%60;b<10&&(b+="0");a=parseInt(a/60);c=a>=12?"pm":"am";a>12&&(a-=12);a==0&&(a=12);return a+":"+b+c}function getOpenHours(a){a=a.split(" ");return{start:getMinutes(a[0],a[1]),end:getMinutes(a[3],a[4])}}function getMinutes(a,b){var c=parseInt(a)*60;a==12&&(c=0);a.indexOf(":")!=-1&&(c+=parseInt(a.substring(a.indexOf(":")+1)));b=="pm"&&(c+=720);return c};
